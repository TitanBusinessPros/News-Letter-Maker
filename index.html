<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Working Newsletter Builder â€” Export Ready</title>
  <style>
    /* [unchanged styles, omitted for brevity] */
  </style>
</head>
<body>
  <!-- [unchanged HTML, omitted for brevity] -->
  <script>
    // DOM [unchanged]
    const inpHead = document.getElementById('inpHead');
    const inpSub = document.getElementById('inpSub');
    const inpBody = document.getElementById('inpBody');
    const inpCtaText = document.getElementById('inpCtaText');
    const inpCtaUrl = document.getElementById('inpCtaUrl');
    const inpCtaPara = document.getElementById('inpCtaPara');
    const inpUnsub = document.getElementById('inpUnsub');
    const inpTheme = document.getElementById('inpTheme');

    const preview = document.getElementById('preview');
    const btnTest = document.getElementById('btnTest');
    const btnExport = document.getElementById('btnExport');

    // Themes [unchanged]
    const THEMES = {
      aurora:{top:'#7c3aed',cta:'#06b6d4'},
      blue:{top:'#2563eb',cta:'#3b82f6'},
      green:{top:'#16a34a',cta:'#22c55e'},
      sunset:{top:'#fb923c',cta:'#ef4444'},
      steel:{top:'#64748b',cta:'#94a3b8'}
    };

    // Escaping helpers
    function escText(s){
      if(s == null) return '';
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
    function escAttr(s){
      // Only escape &, ", <, >
      if (s == null) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('"', '&quot;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    // Convert body to paragraphs [unchanged]
    function bodyToHtml(text){
      if(!text) return '';
      const parts = String(text).split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
      return parts.map(p => `<p style="margin:0 0 14px 0;color:#334155;font-size:16px;line-height:1.6">${escText(p).replace(/\n/g,'<br>')}</p>`).join('');
    }

    // Build the standalone email HTML (table-based, inline styles)
    function buildEmailHtml(){
      const theme = THEMES[inpTheme.value] || THEMES.aurora;
      const title = escText(inpHead.value || '');
      const sub = escText(inpSub.value || '');
      const bodyHtml = bodyToHtml(inpBody.value || '');
      const ctaText = escText(inpCtaText.value || '');
      const ctaUrl = inpCtaUrl.value ? escAttr(inpCtaUrl.value) : '#';
      const ctaPara = escText(inpCtaPara.value || '');
      const unsub = inpUnsub.value ? escAttr(inpUnsub.value) : '{{unsubscribe}}';

      // Minimal email-safe template (tables + inline styles). Links open in new tab.
      return `<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${title || 'Newsletter'}</title>
</head>
<body style="margin:0;padding:20px;background:${theme.top};font-family:Arial,Helvetica,sans-serif;color:#071022;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
    <tr>
      <td align="center">
        <table role="presentation" width="640" cellpadding="0" cellspacing="0" style="max-width:100%;background:#ffffff;border-radius:10px;overflow:hidden;border-collapse:collapse;">
          <tr>
            <td style="padding:28px 20px;text-align:center;background:${theme.top};color:#ffffff;">
              <h1 style="margin:0;font-size:22px;line-height:1.1">${title}</h1>
              <div style="margin-top:8px;color:#e6eef8;font-size:15px">${sub}</div>
            </td>
          </tr>

          <tr>
            <td style="padding:20px 20px;text-align:left;">
              ${bodyHtml}
            </td>
          </tr>

          <tr>
            <td style="padding:22px 20px;text-align:center;">
              <a href="${ctaUrl}" target="_blank" rel="noopener noreferrer" style="display:inline-block;padding:12px 22px;border-radius:8px;background:${theme.cta};color:#061022;text-decoration:none;font-weight:800">${ctaText}</a>
              <div style="max-width:640px;margin:12px auto 0;color:#475569;line-height:1.6;word-wrap:break-word;text-align:left">
                ${ctaPara ? `<p style="margin:0">${escText(ctaPara)}</p>` : ''}
              </div>
            </td>
          </tr>

          <tr>
            <td style="padding:18px 20px;text-align:center;color:#94a3b8;font-size:13px;">
              <a href="${unsub}" target="_blank" rel="noopener noreferrer" style="color:${theme.cta};text-decoration:none">Unsubscribe</a>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;
    }

    // Render the preview inside builder [unchanged]
    function renderPreview(){
      try{
        preview.innerHTML = buildEmailHtml();
      }catch(e){
        preview.textContent = 'Preview failed: ' + e.message;
      }
    }

    // Export and Test link [unchanged]
    function exportHtml(){
      const html = buildEmailHtml();
      const blob = new Blob([html], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'newsletter.html';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    }
    function openTestLink(){
      const html = buildEmailHtml();
      const blob = new Blob([html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }

    // Wire events [unchanged]
    [inpHead, inpSub, inpBody, inpCtaText, inpCtaUrl, inpCtaPara, inpUnsub, inpTheme].forEach(el=>{
      el.addEventListener('input', renderPreview);
    });
    btnExport.addEventListener('click', exportHtml);
    btnTest.addEventListener('click', openTestLink);

    // initial render
    renderPreview();
  </script>
</body>
</html>
